<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Task Automation with Fabric &mdash; training.codefellows 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="training.codefellows 1.0 documentation" href="../../index.html" />
    <link rel="up" title="Day 12" href="index.html" />
    <link rel="prev" title="Consuming Data from a RESTful Web Service" href="rest.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="rest.html" title="Consuming Data from a RESTful Web Service"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">training.codefellows 1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Assignments</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Day 12</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="task-automation-with-fabric">
<h1>Task Automation with Fabric<a class="headerlink" href="#task-automation-with-fabric" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For this tutorial, you will want to have the <a class="reference external" href="http://docs.fabfile.org/en/1.8/index.html">documentation for fabric</a> at hand</p>
</div>
<p>We&#8217;ve looked at creating and destroying new AWS EC2 instances using the Python
wrapper for the AWS API, <tt class="docutils literal"><span class="pre">boto</span></tt>.</p>
<p>Once you have a server, you want to do something useful with it. Possible tasks
might include:</p>
<ul class="simple">
<li>installing system packages you require to support your application</li>
<li>generating configuration for those packages</li>
<li>installing your application software</li>
<li>...</li>
</ul>
<p>Manually performing these tasks is tedious. Once you have figured out how to
configure a system properly for your application, why would you want to do it
over and over again?</p>
<p>Instead, you should automate these tasks.</p>
<p>Automation ensures that you can accomplish a task with a single command, which
encourages actually doing that task more often.</p>
<p>One package available for Python to accomplish this sort of task automation is
<a class="reference external" href="http://docs.fabfile.org/en/latest/">fabric</a>. It provides a uniform interface for performing tasks either locally
or on one or more remote server.</p>
<p><tt class="docutils literal"><span class="pre">Fabric</span></tt> uses SSH to handle communications between your local machine and the
system you are working on, so any command you can run from a terminal is
available to be automated.</p>
<p>In this quick tutorial, we&#8217;ll walk through the process of automating the
provisioning of a new AWS EC2 instance and then installing some software on the
new system.</p>
<div class="section" id="setting-up">
<h2>Setting Up<a class="headerlink" href="#setting-up" title="Permalink to this headline">¶</a></h2>
<p>To begin with, let&#8217;s create an environment suitable for exploring <tt class="docutils literal"><span class="pre">fabric</span></tt>
and using <tt class="docutils literal"><span class="pre">boto</span></tt> to set up remote servers.</p>
<p>Begin by creating a new virtualenv project:</p>
<div class="highlight-bash"><div class="highlight"><pre>heffalump:~ cewing$ mkproject fabrictests
New python executable in fabrictests/bin/python
Installing setuptools, pip...done.
Creating /Users/cewing/projects/fabrictests
Setting project for fabrictests to /Users/cewing/projects/fabrictests
[fabrictests]
heffalump:fabrictests cewing$
</pre></div>
</div>
<p>Once that&#8217;s handled, let&#8217;s install <em>both</em> boto <em>and</em> fabric:</p>
<div class="highlight-bash"><div class="highlight"><pre>[fabrictests]
heffalump:fabrictests cewing$ pip install boto fabric
Downloading/unpacking boto
  Downloading boto-2.25.0-py2.py3-none-any.whl (1.1MB): 1.1MB downloaded
Downloading/unpacking fabric
  Downloading Fabric-1.8.2.tar.gz (251kB): 251kB downloaded
...
... (lots of c-compilation stuff)
Successfully installed boto fabric paramiko pycrypto ecdsa
Cleaning up...
[fabrictests]
heffalump:fabrictests cewing$
</pre></div>
</div>
<p>Notice that fabric, since it operates over SSH, requires the Python ssh library
<tt class="docutils literal"><span class="pre">paramiko</span></tt>.</p>
<p>Because <tt class="docutils literal"><span class="pre">fabric</span></tt> will use SSH to connect to <strong>all</strong> hosts, including your
local machine, you&#8217;ll need to enable SSH access for your computer.</p>
</div>
<div class="section" id="one-more-thing">
<h2>One More Thing<a class="headerlink" href="#one-more-thing" title="Permalink to this headline">¶</a></h2>
<p>We are going to set up an HTTP server on our ubuntu instance.  In order to
prove that we&#8217;ve done it, we need to be able to connect to that server via HTTP
(port 80).</p>
<p>Before you go any further, open your AWS web console. Navigate to the EC2
dashboard, and then select the &#8216;Security Groups&#8217; controls.</p>
<p>Find your <tt class="docutils literal"><span class="pre">ssh-access</span></tt> security group and add a new TCP rule. Allow HTTP
access via port 80 from any address.</p>
<p>Don&#8217;t forget to apply your rules changes after adding the new rule, or it won&#8217;t
take effect.</p>
</div>
<div class="section" id="fabric-basics">
<h2>Fabric Basics<a class="headerlink" href="#fabric-basics" title="Permalink to this headline">¶</a></h2>
<p><tt class="docutils literal"><span class="pre">Fabric</span></tt> operates by providing a single command <tt class="docutils literal"><span class="pre">fab</span></tt>.</p>
<p>This command looks for a file in your present working directory called
<tt class="docutils literal"><span class="pre">fabfile</span></tt> or <tt class="docutils literal"><span class="pre">fabfile.py</span></tt>. If there is none, it will throw an error:</p>
<div class="highlight-bash"><div class="highlight"><pre>[fabrictests]
heffalump:fabrictests cewing$ fab

Fatal error: Couldn&#39;t find any fabfiles!

Remember that -f can be used to specify fabfile path, and use -h for help.

Aborting.
[fabrictests]
heffalump:fabrictests cewing$
</pre></div>
</div>
<p>Let&#8217;s start by creating a new fabfile here in the <tt class="docutils literal"><span class="pre">fabrictests</span></tt> project
directory:</p>
<div class="highlight-bash"><div class="highlight"><pre>fabrictests]
heffalump:fabrictests cewing$ touch fabfile.py
[fabrictests]
heffalump:fabrictests cewing$
</pre></div>
</div>
<p>What goes into that file?</p>
<p>Python code.</p>
<p>Let&#8217;s start by creating a very simple test Python function we can use to show
how fabric works in general.</p>
<p>Open <tt class="docutils literal"><span class="pre">fabfile.py</span></tt> in your editor and add the following code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">run</span>

<span class="k">def</span> <span class="nf">host_type</span><span class="p">():</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;uname -s&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Once you&#8217;ve saved this, the name of the new Python function becomes available
as a <tt class="docutils literal"><span class="pre">subcommand</span></tt> for the <tt class="docutils literal"><span class="pre">fab</span></tt> command:</p>
<div class="highlight-bash"><div class="highlight"><pre>[fabrictests]
heffalump:fabrictests cewing$ fab -H localhost host_type
[localhost] Executing task &#39;host_type&#39;
[localhost] run: uname -s
[localhost] Login password for &#39;cewing&#39;:
[localhost] out: Darwin
[localhost] out:


Done.
Disconnecting from localhost... done.
[fabrictests]
heffalump:fabrictests cewing$
</pre></div>
</div>
<p>Notice that you&#8217;re local machine has prompted you to login with a password.
That&#8217;s a good thing. If you <a class="reference external" href="http://stackoverflow.com/questions/7260/how-do-i-setup-public-key-authentication">enable publickey login</a> then <tt class="docutils literal"><span class="pre">fabric</span></tt> will skip
this part for you. This also means that you won&#8217;t be sending your password
across a connection, so that&#8217;s nice.</p>
<div class="section" id="the-fabric-environment">
<h3>The Fabric Environment<a class="headerlink" href="#the-fabric-environment" title="Permalink to this headline">¶</a></h3>
<p>Having to specify a host to connect to is a bit awkward, so <tt class="docutils literal"><span class="pre">fabric</span></tt> provides
a mechanism for setting this up automatically.</p>
<p>The <tt class="docutils literal"><span class="pre">fabric.api</span></tt> module provides a symbol <tt class="docutils literal"><span class="pre">env</span></tt> that allows you to share
state between different fabric tasks.  This state can be mutated locally, both
at module level and from within a given task.</p>
<p>You can hang pretty much any symbol onto this object, which is really just a
fancy Python dictionary.</p>
<p>However, there are a number of environmental settings that are present from the
get-go, and which <tt class="docutils literal"><span class="pre">fabric</span></tt> will refer to automatically.</p>
<p>One of these is <tt class="docutils literal"><span class="pre">hosts</span></tt>.  When we invoked the <tt class="docutils literal"><span class="pre">fab</span></tt> command with <tt class="docutils literal"><span class="pre">-H</span>
<span class="pre">localhost</span></tt> we were pre-populating this env attribute with the string
&#8216;localhost&#8217;.  We can do this manually.  Update your <tt class="docutils literal"><span class="pre">fabfile.py</span></tt> as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">run</span>
<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">env</span>

<span class="n">env</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="p">]</span>

<span class="k">def</span> <span class="nf">host_type</span><span class="p">():</span>
    <span class="n">run</span><span class="p">(</span><span class="s">&#39;uname -s&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Save those changes and you should now be able to run the <tt class="docutils literal"><span class="pre">host_type</span></tt>
subcommand without providing the host explicitly:</p>
<div class="highlight-bash"><div class="highlight"><pre>[fabrictests]
heffalump:fabrictests cewing$ fab host_type
[localhost] Executing task &#39;host_type&#39;
[localhost] run: uname -s
[localhost] Login password for &#39;cewing&#39;:
[localhost] out: Darwin
[localhost] out:


Done.
Disconnecting from localhost... done.
[fabrictests]
heffalump:fabrictests cewing$
</pre></div>
</div>
</div>
</div>
<div class="section" id="fabric-with-boto">
<h2>Fabric with Boto<a class="headerlink" href="#fabric-with-boto" title="Permalink to this headline">¶</a></h2>
<p>Our interactions with <tt class="docutils literal"><span class="pre">boto</span></tt> are all oriented around creating and destroying
servers.</p>
<p>In fabric, our orientation will be toward manipulating <em>a server</em> once it
exists.</p>
<p>Before we do that, though we need to get a server running.</p>
<p>Any attempt we make at dealing with AWS EC2 will require that we have a
connection, so our first step should be to make a connection to the region we
want to use.  Let&#8217;s add a function to do this to our <tt class="docutils literal"><span class="pre">fabfile.py</span></tt></p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># add an import</span>
<span class="kn">import</span> <span class="nn">boto.ec2</span>

<span class="c"># add an environmental setting</span>
<span class="n">env</span><span class="o">.</span><span class="n">aws_region</span> <span class="o">=</span> <span class="s">&#39;us-west-2&#39;</span>

<span class="c"># add a function</span>
<span class="k">def</span> <span class="nf">get_ec2_connection</span><span class="p">():</span>
    <span class="k">if</span> <span class="s">&#39;ec2&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">connect_to_region</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">aws_region</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">ec2</span> <span class="o">=</span> <span class="n">conn</span>
            <span class="k">print</span> <span class="s">&quot;Connected to EC2 region </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">env</span><span class="o">.</span><span class="n">aws_region</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Unable to connect to EC2 region </span><span class="si">%s</span><span class="s">&quot;</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="n">env</span><span class="o">.</span><span class="n">aws_region</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">ec2</span>
</pre></div>
</div>
<p>We can call fabric functions from other fabric functions, so this will be of
use to us as we try to provision, manage and deprovision our servers.</p>
<div class="section" id="provisioning-an-instance">
<h3>Provisioning an Instance<a class="headerlink" href="#provisioning-an-instance" title="Permalink to this headline">¶</a></h3>
<p>In the <tt class="docutils literal"><span class="pre">boto</span></tt> walkthrough, we saw how to provision a new instance and set it
running.  Let&#8217;s convert that code to a fabric task.</p>
<p>We&#8217;ll need to start by getting a connection, then use that connection to create
a new instance.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># add an import at the top</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c"># add this function</span>
<span class="k">def</span> <span class="nf">provision_instance</span><span class="p">(</span><span class="n">wait_for_running</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">wait_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
    <span class="n">timeout_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_ec2_connection</span><span class="p">()</span>
    <span class="n">instance_type</span> <span class="o">=</span> <span class="s">&#39;t1.micro&#39;</span>
    <span class="n">key_name</span> <span class="o">=</span> <span class="s">&#39;pk-cpe&#39;</span>
    <span class="n">security_group</span> <span class="o">=</span> <span class="s">&#39;ssh-access&#39;</span>
    <span class="n">image_id</span> <span class="o">=</span> <span class="s">&#39;ami-d0d8b8e0&#39;</span>

    <span class="n">reservations</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_instances</span><span class="p">(</span>
        <span class="n">image_id</span><span class="p">,</span>
        <span class="n">key_name</span><span class="o">=</span><span class="n">key_name</span><span class="p">,</span>
        <span class="n">instance_type</span><span class="o">=</span><span class="n">instance_type</span><span class="p">,</span>
        <span class="n">security_groups</span><span class="o">=</span><span class="p">[</span><span class="n">security_group</span><span class="p">,</span> <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">new_instances</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">reservations</span><span class="o">.</span><span class="n">instances</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s">u&#39;pending&#39;</span><span class="p">]</span>
    <span class="n">running_instance</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">wait_for_running</span><span class="p">:</span>
        <span class="n">waited</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">new_instances</span> <span class="ow">and</span> <span class="p">(</span><span class="n">waited</span> <span class="o">&lt;</span> <span class="n">timeout_val</span><span class="p">):</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_val</span><span class="p">)</span>
            <span class="n">waited</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">wait_val</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">new_instances</span><span class="p">:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">state</span>
                <span class="k">print</span> <span class="s">&quot;Instance </span><span class="si">%s</span><span class="s"> is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s">&quot;running&quot;</span><span class="p">:</span>
                    <span class="n">running_instance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">new_instances</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">new_instances</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>There&#8217;s something new in this function.  It accepts arguments. We can pass
arguments like this from the command-line when we run the command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>fabrictests<span class="o">]</span>
heffalump:fabrictests cewing<span class="nv">$ </span>fab provision_instance
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>fabrictests<span class="o">]</span>
heffalump:fabrictests cewing<span class="nv">$ </span>fab provision_instance:wait_for_running<span class="o">=</span>1
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>fabrictests<span class="o">]</span>
heffalump:fabrictests cewing<span class="nv">$ </span>fab provision_instance:wait_for_running<span class="o">=</span>1,interval<span class="o">=</span>5
</pre></div>
</div>
<p>The important part to know about this is that arguments passed in from the
command line appear in your function as strings.  You are responsible for
converting them if needed.</p>
<p>Let&#8217;s provision a new server with this function:</p>
<div class="highlight-bash"><div class="highlight"><pre>[fabrictests]
heffalump:fabrictests cewing$ fab provision_instance:wait_for_running=1
[localhost] Executing task &#39;provision_instance&#39;
Connected to EC2 region us-west-2
Instance i-8c424a85 is pending
Instance i-8c424a85 is pending
Instance i-8c424a85 is pending
Instance i-8c424a85 is pending
Instance i-8c424a85 is pending
Instance i-8c424a85 is pending
Instance i-8c424a85 is pending
Instance i-8c424a85 is running

Done.
[fabrictests]
heffalump:fabrictests cewing$
</pre></div>
</div>
<p>Once the function completes, you should be able to load your EC2 dashboard and
see the new instance you just created running happily.</p>
</div>
</div>
<div class="section" id="running-shell-commands-on-a-server">
<h2>Running Shell Commands on a Server<a class="headerlink" href="#running-shell-commands-on-a-server" title="Permalink to this headline">¶</a></h2>
<p>Now that we have an instance running, we want to run commands on it to
configure it.</p>
<p>Fabric provides the <tt class="docutils literal"><span class="pre">run</span></tt> command to support this.</p>
<p>But there&#8217;s an issue.  When you execute a function using fabric, it is actually
run repeatedly, once for each <tt class="docutils literal"><span class="pre">host</span></tt> you list in the <tt class="docutils literal"><span class="pre">env.hosts</span></tt>
environment setting.</p>
<p>At the moment, our script lists &#8216;localhost&#8217;, but we don&#8217;t actually want to run
this command on &#8216;localhost&#8217;, so we need to get around this.</p>
<p>Fabric provides the <tt class="docutils literal"><span class="pre">execute</span></tt> command specifically for this purpose.  We can
pass it the list of hosts on which we want to run a particular command, and it
will do so for us.</p>
<p>In order to play with that, though, we need to interactively select the
instance we want to use (after all, we might have more than one, right?).</p>
<p>We&#8217;ll begin by building a function that allows us to list instances, optionally
filtering for a particular state:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">list_aws_instances</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_ec2_connection</span><span class="p">()</span>

    <span class="n">reservations</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">get_all_reservations</span><span class="p">()</span>
    <span class="n">instances</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">reservations</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span> <span class="ow">or</span> <span class="n">instance</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">state</span><span class="p">:</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">instance_type</span><span class="p">,</span>
                    <span class="s">&#39;image&#39;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">image_id</span><span class="p">,</span>
                    <span class="s">&#39;state&#39;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                    <span class="s">&#39;instance&#39;</span><span class="p">:</span> <span class="n">instance</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">instances</span> <span class="o">=</span> <span class="n">instances</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pprint</span>
        <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">instances</span><span class="p">)</span>
</pre></div>
</div>
<p>If we run this command from the command line, we should see our running
instance:</p>
<div class="highlight-bash"><div class="highlight"><pre>[fabrictests]
heffalump:fabrictests cewing$ fab list_aws_instances:verbose=1,state=running
[localhost] Executing task &#39;list_aws_instances&#39;
Connected to EC2 region us-west-2
[{&#39;id&#39;: u&#39;i-ab5159a2&#39;,
  &#39;image&#39;: u&#39;ami-d0d8b8e0&#39;,
  &#39;instance&#39;: Instance:i-ab5159a2,
  &#39;state&#39;: u&#39;running&#39;,
  &#39;type&#39;: u&#39;t1.micro&#39;}]

Done.
[fabrictests]
heffalump:fabrictests cewing$
</pre></div>
</div>
<p>Nice.</p>
<p>Now we can create a function that will take the output of that function and
give us a choice of running instances on which to take a given action:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># add an import</span>
<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">prompt</span>

<span class="k">def</span> <span class="nf">select_instance</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s">&#39;running&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">active_instance</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">list_aws_instances</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>

    <span class="n">prompt_text</span> <span class="o">=</span> <span class="s">&quot;Please select from the following instances:</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="n">instance_template</span> <span class="o">=</span> <span class="s">&quot; </span><span class="si">%(ct)d</span><span class="s">: </span><span class="si">%(state)s</span><span class="s"> instance </span><span class="si">%(id)s</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">instances</span><span class="p">):</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;ct&#39;</span><span class="p">:</span> <span class="n">ct</span><span class="p">}</span>
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="n">prompt_text</span> <span class="o">+=</span> <span class="n">instance_template</span> <span class="o">%</span> <span class="n">args</span>
    <span class="n">prompt_text</span> <span class="o">+=</span> <span class="s">&quot;Choose an instance: &quot;</span>

    <span class="k">def</span> <span class="nf">validation</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">choice</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">instances</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> is not a valid instance&quot;</span> <span class="o">%</span> <span class="n">choice</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">choice</span>

    <span class="n">choice</span> <span class="o">=</span> <span class="n">prompt</span><span class="p">(</span><span class="n">prompt_text</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validation</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">active_instance</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">choice</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s">&#39;instance&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">fabric.api.prompt</span></tt> function allows us to use an interaction like
<tt class="docutils literal"><span class="pre">raw_input</span></tt> to ask for input from the fabric user. Here, we build a list of
the available instances that are &#8216;running&#8217;, and then ask the user to choose
among them. After a valid choice is made, we can then hang that instance on our
<tt class="docutils literal"><span class="pre">env</span></tt> so that we can access it from other functions. We can also
short-circuit this behavior by checking first to see if we&#8217;ve already selected
an instance.</p>
<p>Noe, let&#8217;s set up a function that will run a given command on the server we
select:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># add an import</span>
<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">execute</span>

<span class="k">def</span> <span class="nf">run_command_on_selected_server</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="n">select_instance</span><span class="p">()</span>
    <span class="n">selected_hosts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&#39;ubuntu@&#39;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="n">active_instance</span><span class="o">.</span><span class="n">public_dns_name</span>
    <span class="p">]</span>
    <span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">hosts</span><span class="o">=</span><span class="n">selected_hosts</span><span class="p">)</span>
</pre></div>
</div>
<p>This function begins by asking the user to select an instance.  Then it sets up
a list of hosts that includes that server (with the username &#8216;ubuntu&#8217;
hard-coded). Finally, it attempts to execute the command we provide as an
argument on the list of hosts we just built.</p>
<p>In order for us to run a command on this server, we need to ensure that the
keypair we set up for our AWS instances is available to the ssh agent. We can
do that at the system level on our local machine:</p>
<div class="highlight-bash"><div class="highlight"><pre>[fabrictests]
heffalump:fabrictests cewing$ ssh-add ~/.ssh/pk-aws.pem
Identity added: /Users/cewing/.ssh/pk-cpe.pem (/Users/cewing/.ssh/pk-cpe.pem)
[fabrictests]
heffalump:fabrictests cewing$
</pre></div>
</div>
<p>Now our local ssh agent knows that this is a file we might use to connect. When
the AWS server asks us to use public-key authentication, the agent will then
try this key along with any others the agent knows about. If no known key
works, ssh will bomb out.</p>
<p><tt class="docutils literal"><span class="pre">Execute</span></tt> will take the name of a fabric command to run. We need a command
that it will run that will install nginx for us and then start it.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># add an import</span>
<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">sudo</span>

<span class="k">def</span> <span class="nf">_install_nginx</span><span class="p">():</span>
    <span class="n">sudo</span><span class="p">(</span><span class="s">&#39;apt-get install nginx&#39;</span><span class="p">)</span>
    <span class="n">sudo</span><span class="p">(</span><span class="s">&#39;/etc/init.d/nginx start&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we need to wrap this function in a function we might call from the
command line that will run it on the server we select:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">install_nginx</span><span class="p">():</span>
    <span class="n">run_command_on_selected_server</span><span class="p">(</span><span class="n">_install_nginx</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, if we run this fabric command from our command line, we can get nginx installed on our AWS instance:</p>
<div class="highlight-bash"><div class="highlight"><pre>[fabrictests]
heffalump:fabrictests cewing$ fab install_nginx
[localhost] Executing task &#39;install_nginx&#39;
Connected to EC2 region us-west-2
Please select from the following instances:
 1: running instance i-ab5159a2
Choose an instance: 1
[ubuntu@ec2-54-185-44-188.us-west-2.compute.amazonaws.com] Executing task &#39;_install_nginx&#39;
[ubuntu@ec2-54-185-44-188.us-west-2.compute.amazonaws.com] sudo: apt-get install nginx
[ubuntu@ec2-54-185-44-188.us-west-2.compute.amazonaws.com] out:
[ubuntu@ec2-54-185-44-188.us-west-2.compute.amazonaws.com] out: Reading package lists... 0%
[ubuntu@ec2-54-185-44-188.us-west-2.compute.amazonaws.com] out:
[ubuntu@ec2-54-185-44-188.us-west-2.compute.amazonaws.com] out: Reading package lists... 0%
[ubuntu@ec2-54-185-44-188.us-west-2.compute.amazonaws.com] out:
[ubuntu@ec2-54-185-44-188.us-west-2.compute.amazonaws.com] out: Reading package lists... 24%
...
...
[ubuntu@ec2-54-185-44-188.us-west-2.compute.amazonaws.com] out: Setting up nginx-full (1.1.19-1ubuntu0.5) ...
[ubuntu@ec2-54-185-44-188.us-west-2.compute.amazonaws.com] out: Setting up nginx (1.1.19-1ubuntu0.5) ...
[ubuntu@ec2-54-185-44-188.us-west-2.compute.amazonaws.com] out: Processing triggers for libc-bin ...
[ubuntu@ec2-54-185-44-188.us-west-2.compute.amazonaws.com] out: ldconfig deferred processing now taking place
[ubuntu@ec2-54-185-44-188.us-west-2.compute.amazonaws.com] out:


Done.
Disconnecting from ubuntu@ec2-54-185-44-188.us-west-2.compute.amazonaws.com... done.
[fabrictests]
heffalump:fabrictests cewing$
</pre></div>
</div>
<p>At this point, you should be able to open a web browser and point it at your
EC2 instance and see the default nginx web page.  Remember, the public_dns_name
of your instance is the way to get at it, so use that in your browser.</p>
</div>
<div class="section" id="stopping-and-terminating-an-instance">
<h2>Stopping and Terminating an Instance<a class="headerlink" href="#stopping-and-terminating-an-instance" title="Permalink to this headline">¶</a></h2>
<p>Challenge yourself to add two more functions:</p>
<ol class="arabic simple">
<li>Select a running instance to stop, and then stop it with boto</li>
<li>Select a stopped instance to terminate, and then terminate it with boto</li>
</ol>
<p>Good Luck!</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Task Automation with Fabric</a><ul>
<li><a class="reference internal" href="#setting-up">Setting Up</a></li>
<li><a class="reference internal" href="#one-more-thing">One More Thing</a></li>
<li><a class="reference internal" href="#fabric-basics">Fabric Basics</a><ul>
<li><a class="reference internal" href="#the-fabric-environment">The Fabric Environment</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fabric-with-boto">Fabric with Boto</a><ul>
<li><a class="reference internal" href="#provisioning-an-instance">Provisioning an Instance</a></li>
</ul>
</li>
<li><a class="reference internal" href="#running-shell-commands-on-a-server">Running Shell Commands on a Server</a></li>
<li><a class="reference internal" href="#stopping-and-terminating-an-instance">Stopping and Terminating an Instance</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="rest.html"
                        title="previous chapter">Consuming Data from a RESTful Web Service</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/assignments/day12/fabric.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="rest.html" title="Consuming Data from a RESTful Web Service"
             >previous</a> |</li>
        <li><a href="../../index.html">training.codefellows 1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Assignments</a> &raquo;</li>
          <li><a href="index.html" >Day 12</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Cris Ewing.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.1.
    </div>
  </body>
</html>